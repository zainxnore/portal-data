<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Open Data Desa Kalitengah</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obh+O+z/c=" crossorigin=""/>

    <style>
        /* CSS UTAMA */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            line-height: 1.6;
            background-color: #f9f9f9;
            color: #333;
            padding: 0;
        }
        nav {
            background-color: #0366d6;
            padding: 10px 0;
            margin-bottom: 20px;
        }
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0 auto;
            max-width: 800px; 
            text-align: center;
        }
        nav ul li {
            display: inline;
            margin: 0 15px;
        }
        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            padding: 5px;
        }
        nav ul li a:hover {
            text-decoration: underline;
        }
        
        header {
            text-align: center;
            border-bottom: 2px solid #eee;
            padding: 40px 20px 20px 20px;
            margin: 0 auto;
            max-width: 800px;
        }
        
        main {
            margin: 20px auto;
            max-width: 800px;
            padding: 0 20px;
        }

        .dataset {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .dataset-title {
            margin-top: 0;
            color: #0366d6;
        }
        .metadata {
            font-size: 0.9em;
            color: #555;
            margin-top: 10px;
            border-top: 1px dashed #eee;
            padding-top: 10px;
            margin-bottom: 10px;
        }
        .metadata span {
            display: inline-block;
            margin-right: 15px;
        }
        .download-link {
             display: inline-block;
             background-color: #28a745;
             color: white;
             padding: 10px 15px;
             text-decoration: none;
             border-radius: 5px;
             font-weight: bold;
             margin-top: 10px;
             margin-right: 10px;
        }
        
        /* CSS untuk Tombol Preview */
        .preview-button {
            display: inline-block;
            background-color: #0366d6;
            color: white;
            padding: 10px 15px;
            text-decoration: none;
            border-radius: 5px;
            font-weight: bold;
            margin-top: 10px;
            cursor: pointer;
            border: none;
        }
        
        /* CSS BARU UNTUK PRATINJAU TABEL */
        .preview-table table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            overflow-x: auto; 
            display: block;
        }
        .preview-table th, .preview-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
            font-size: 0.9em;
            white-space: nowrap;
        }
        .preview-table th {
            background-color: #f2f2f2;
        }
        
        /* CSS untuk menyembunyikan kontainer pratinjau secara default */
        .preview-container {
            display: none;
            margin-top: 20px;
            padding-top: 10px;
            border-top: 1px dashed #ddd;
        }
        
        footer {
            text-align: center; 
            color: #777; 
            padding: 20px;
            border-top: 1px solid #eee;
            margin: 20px auto 0 auto;
            max-width: 800px;
        }
        
        /* CSS BARU UNTUK KOTAK SEARCH */
        #searchInput {
            width: 100%; 
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 25px; 
            box-sizing: border-box; 
            font-size: 16px;
        }

        /* CSS BARU UNTUK FILTER KATEGORI */
        .category-filter {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }
        .category-filter button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f0f0f0;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s, border-color 0.2s;
        }
        .category-filter button:hover {
            background-color: #e0e0e0;
        }
        .category-filter button.active {
            background-color: #0366d6;
            color: white;
            border-color: #0366d6;
        }
        
    </style>
</head>
<body>
    
    <nav>
        <ul>
            <li><a href="index.html">Beranda</a></li>
            <li><a href="tentang.html">Tentang</a></li>
            <li><a href="kontak.html">Kontak</a></li>
        </ul>
    </nav>

    <header>
        <h1>Portal Open Data Desa Kalitengah</h1>
        <p>Kumpulan data yang dipublikasikan untuk umum, transparan, dan dapat diakses siapa saja.</p>
    </header>

    <main id="main"> 
    
        <h3 style="margin-bottom: 10px;">Filter Cepat Berdasarkan Kategori:</h3>
        <div class="category-filter" id="categoryFilterButtons">
            <button class="active" onclick="filterByCategory(this, 'SEMUA')">Semua Data</button>
            <button onclick="filterByCategory(this, 'Demografi')">Demografi</button>
            <button onclick="filterByCategory(this, 'Infrastruktur')">Infrastruktur</button>
            <button onclick="filterByCategory(this, 'Keuangan')">Keuangan</button>
            <button onclick="filterByCategory(this, 'Kesejahteraan Sosial')">Kesejahteraan Sosial</button>
        </div>
        <label for="searchInput" style="font-size: 1.2em; font-weight: bold; color: #333;">Cari Dataset:</label>
        <input type="text" id="searchInput" onkeyup="filterData()" placeholder="Ketik nama data, misal: 'penduduk' atau 'anggaran'...">

        <section class="dataset">
            <h2 class="dataset-title">Data Penduduk per Dusun</h2>
            <p>Deskripsi singkat data: Ini adalah data jumlah penduduk per kelompok usia di Desa Kalitengah pada tahun 2024.</p>
            <div class="metadata">
                <span>**Kategori**: Demografi</span>
                <span>**Format**: CSV</span>
                <span>**Periode**: 2024</span>
                <span>**Update**: 2024-09-01</span>
            </div>
            
            <a href="data_kependudukan_kalitengah_2024.csv" class="download-link" download>Download Data (CSV)</a>
            <button class="preview-button" onclick="togglePreview(this, 'preview-container-kependudukan', 'csv-kependudukan', 'preview-kependudukan', 6)">Lihat Pratinjau</button>
            
            <div id="preview-container-kependudukan" class="preview-container">
                <h4 style="margin-top: 0;">Pratinjau (6 Baris Pertama)</h4>
                <div id="preview-kependudukan" class="preview-table"></div>
                
                <h4 style="margin-top: 25px;">Grafik Total Penduduk per Dusun:</h4>
                <canvas id="chart-kependudukan" style="max-height: 300px;"></canvas>
                </div>

            <pre class="raw-csv-data" id="csv-kependudukan" style="display:none;">
dusun,kelompok_usia,jumlah_laki_laki,jumlah_perempuan,total
Dusun Krajan,0-5 Tahun,45,42,87
Dusun Krajan,6-17 Tahun,110,115,225
Dusun Krajan,18-55 Tahun,350,345,695
Dusun Krajan,> 55 Tahun,80,95,175
Dusun Gebang,0-5 Tahun,30,33,63
Dusun Gebang,6-17 Tahun,90,85,175
Dusun Gebang,18-55 Tahun,280,290,570
Dusun Gebang,> 55 Tahun,65,70,135
Dusun Sawahan,0-5 Tahun,25,28,53
Dusun Sawahan,6-17 Tahun,75,80,155
Dusun Sawahan,18-55 Tahun,210,215,425
Dusun Sawahan,> 55 Tahun,50,60,110
            </pre>
        </section>

        <section class="dataset">
            <h2 class="dataset-title">Data Fasilitas Umum</h2>
            <p>Deskripsi singkat data: Data ini berisi lokasi koordinat beberapa fasilitas umum di Desa Kalitengah dalam format tabel datar.</p>
            <div class="metadata">
                <span>**Kategori**: Infrastruktur</span>
                <span>**Format**: CSV</span>
                <span>**Periode**: Terbaru</span>
                <span>**Update**: 2024-09-01</span>
            </div>
            
            <a href="data_fasilitas_umum_kalitengah.csv" class="download-link" download>Download Data (CSV)</a>
            <button class="preview-button" onclick="togglePreview(this, 'preview-container-fasilitas', 'csv-fasilitas', 'preview-fasilitas', 6)">Lihat Pratinjau</button>
            
            <div id="preview-container-fasilitas" class="preview-container">
                <h4 style="margin-top: 0;">Pratinjau (6 Baris Pertama)</h4>
                <div id="preview-fasilitas" class="preview-table"></div>

                <h4 style="margin-top: 25px;">Peta Lokasi Fasilitas Umum:</h4>
                <div id="map-fasilitas" style="height: 350px; border-radius: 8px;"></div>
                </div>

            <pre class="raw-csv-data" id="csv-fasilitas" style="display:none;">
id,nama_fasilitas,kategori,dusun,alamat,latitude,longitude
FAS-001,Kantor Desa Kalitengah,Pemerintahan,Krajan,Jl. Raya Kalitengah No. 1,-7.12345,110.12345
FAS-002,SD Negeri Kalitengah 1,Pendidikan,Krajan,Jl. Pendidikan No. 10,-7.124,110.124
FAS-003,Posyandu Mekar Jaya,Kesehatan,Gebang,Jl. Sehat No. 5,-7.1255,110.1255
FAS-004,Masjid Jami' Al-Hidayah,Tempat Ibadah,Sawahan,Jl. Ibadah No. 1,-7.126,110.126
FAS-005,Pasar Desa Kalitengah,Ekonomi,Krajan,Jl. Pasar Lama No. 50,-7.123,110.123
            </pre>
        </section>

        <section class="dataset">
            <h2 class="dataset-title">Data Anggaran Desa Kalitengah</h2>
            <p>Deskripsi singkat data: Data ini berisi anggaran pendapatan dan belanja desa (APBDes) tahun 2024.</p>
            <div class="metadata">
                <span>**Kategori**: Keuangan</span>
                <span>**Format**: CSV</span>
                <span>**Periode**: 2024</span>
                <span>**Update**: 2024-09-01</span>
            </div>
            
            <a href="data_anggaran_desa_kalitengah_2024.csv" class="download-link" download>Download Data (CSV)</a>
            <button class="preview-button" onclick="togglePreview(this, 'preview-container-anggaran', 'csv-anggaran', 'preview-anggaran', 7)">Lihat Pratinjau</button>
            
            <div id="preview-container-anggaran" class="preview-container">
                <h4 style="margin-top: 0;">Pratinjau (7 Baris Pertama)</h4>
                <div id="preview-anggaran" class="preview-table"></div>

                <h4 style="margin-top: 25px;">Proporsi Anggaran per Bidang:</h4>
                <div style="max-width: 400px; margin: 0 auto;">
                    <canvas id="chart-anggaran"></canvas>
                </div>
                </div>

            <pre class="raw-csv-data" id="csv-anggaran" style="display:none;">
bidang,kegiatan,anggaran_rp,realisasi_rp,persentase_realisasi
Penyelenggaraan Pemerintahan Desa,Operasional Kantor Desa,150000000,145000000,96.67
Penyelenggaraan Pemerintahan Desa,Tunjangan Aparatur Desa,300000000,300000000,100.00
Pelaksanaan Pembangunan Desa,Pembangunan Jalan Dusun Gebang,250000000,250000000,100.00
Pelaksanaan Pembangunan Desa,Pembangunan Drainase Dusun Sawahan,120000000,115000000,95.83
Pelaksanaan Pembangunan Desa,Operasional Posyandu,40000000,40000000,100.00
Pembinaan Kemasyarakatan,Pelatihan PKK,25000000,24500000,98.00
Pembinaan Kemasyarakatan,Pembinaan Karang Taruna,30000000,28000000,93.33
            </pre>
        </section>
        
        <section class="dataset">
            <h2 class="dataset-title">Data Bantuan Sosial Desa Kalitengah</h2>
            <p>Deskripsi singkat data: Data ini berisi rekapitulasi jumlah penerima bantuan sosial per program tahun 2024.</p>
            <div class="metadata">
                <span>**Kategori**: Kesejahteraan Sosial</span>
                <span>**Format**: CSV</span>
                <span>**Periode**: 2024</span>
                <span>**Update**: 2024-09-01</span>
            </div>
            
            <a href="data_bantuan_sosial_kalitengah_2024.csv" class="download-link" download>Download Data (CSV)</a>
            <button class="preview-button" onclick="togglePreview(this, 'preview-container-bantuan', 'csv-bantuan', 'preview-bantuan', 6)">Lihat Pratinjau</button>
            
            <div id="preview-container-bantuan" class="preview-container">
                <h4 style="margin-top: 0;">Pratinjau (6 Baris Pertama)</h4>
                <div id="preview-bantuan" class="preview-table"></div>
            </div>

            <pre class="raw-csv-data" id="csv-bantuan" style="display:none;">
nama_program_bantuan,sumber_dana,sasaran,jumlah_penerima_kk
Bantuan Pangan Non-Tunai (BPNT),Kemensos RI,Keluarga Kurang Mampu,210
Program Keluarga Harapan (PKH),Kemensos RI,Keluarga Sangat Kurang Mampu,130
Bantuan Langsung Tunai - Dana Desa (BLT-DD),Dana Desa,Keluarga Miskin Ekstrem,85
Bantuan Perbaikan Rumah Tidak Layak Huni (RTLH),APBD Kabupaten,Keluarga Kurang Mampu,15
Bantuan Siswa Miskin (BSM),APBD Kabupaten,Siswa Kurang Mampu,55
            </pre>
        </section>

    </main>

    <footer>
        <p>Website ini dibuat menggunakan GitHub Pages.</p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script> 

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20n6a9c8z9G6yqU5B6J5B/L4Z0r2l0M0t6w/r4k6l6M=" crossorigin=""></script>
    
    <script>
    
    // VARIABEL GLOBAL UNTUK INSTANCE PETA DAN GRAFIK
    let mapFasilitas = null;
    let window.populationChart = null; // Didefinisikan di window agar bisa di-destroy
    let window.anggaranChart = null;

    // FUNGSI 1: FILTER/SEARCH DATASET
    function filterData() {
        var input = document.getElementById('searchInput');
        var filter = input.value.toUpperCase();
        var main = document.getElementById('main');
        var cards = main.getElementsByClassName('dataset');
        
        // Nonaktifkan tombol kategori saat melakukan pencarian
        const buttons = document.getElementById('categoryFilterButtons').getElementsByTagName('button');
        for (let i = 0; i < buttons.length; i++) {
             buttons[i].classList.remove('active');
        }

        for (var i = 0; i < cards.length; i++) {
            var title = cards[i].getElementsByTagName('h2')[0];
            if (title) {
                var txtValue = cards[i].textContent || cards[i].innerText;
                
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    cards[i].style.display = "";
                } else {
                    cards[i].style.display = "none";
                }
            }
        }
    }

    // FUNGSI 2: FILTER BERDASARKAN KATEGORI
    function filterByCategory(buttonElement, category) {
        const main = document.getElementById('main');
        const cards = main.getElementsByClassName('dataset');
        const buttons = document.getElementById('categoryFilterButtons').getElementsByTagName('button');

        for (let i = 0; i < buttons.length; i++) {
            buttons[i].classList.remove('active');
        }
        buttonElement.classList.add('active');
        
        document.getElementById('searchInput').value = '';

        for (let i = 0; i < cards.length; i++) {
            const dataset = cards[i];
            const categorySpan = dataset.querySelector('.metadata span:nth-child(1)'); 
            
            if (category === 'SEMUA') {
                dataset.style.display = "";
            } else if (categorySpan) {
                const categoryText = categorySpan.textContent.split(':').pop().trim();

                if (categoryText === category) {
                    dataset.style.display = "";
                } else {
                    dataset.style.display = "none";
                }
            }
        }
    }
    
    // FUNGSI 3: KONVERTER CSV KE TABEL HTML
    function generatePreview(csvElementId, outputElementId, maxRows) {
        const csvElement = document.getElementById(csvElementId);
        const outputElement = document.getElementById(outputElementId);

        if (!csvElement || !outputElement) return;

        const csvData = csvElement.textContent.trim();
        const rows = csvData.split('\n');
        
        const previewRows = rows.slice(0, maxRows);
        
        let html = '<table>';
        
        // Buat Header
        const headers = previewRows[0].split(',');
        html += '<thead><tr>';
        headers.forEach(header => {
            html += `<th>${header.trim()}</th>`;
        });
        html += '</tr></thead><tbody>';

        // Buat Data
        for (let i = 1; i < previewRows.length; i++) {
            const columns = previewRows[i].split(',');
            html += '<tr>';
            columns.forEach(column => {
                html += `<td>${column.trim()}</td>`;
            });
            html += '</tr>';
        }

        html += '</tbody></table>';
        outputElement.innerHTML = html;
    }
    
    // FUNGSI 4: MEMPROSES DATA CSV PENDUDUK UNTUK CHART
    function processPopulationData() {
        const csvElement = document.getElementById('csv-kependudukan');
        if (!csvElement) return null;

        const csvData = csvElement.textContent.trim();
        const rows = csvData.split('\n');
        
        const totals = {};
        const header = rows[0].split(',').map(h => h.trim());
        const totalIndex = header.indexOf('total'); 
        const dusunIndex = header.indexOf('dusun'); 

        if (totalIndex === -1 || dusunIndex === -1) return null;

        for (let i = 1; i < rows.length; i++) {
            const columns = rows[i].split(',');
            const dusun = columns[dusunIndex].trim();
            const total = parseInt(columns[totalIndex].trim());

            if (totals[dusun]) {
                totals[dusun] += total;
            } else {
                totals[dusun] = total;
            }
        }
        
        return {
            labels: Object.keys(totals),
            data: Object.values(totals)
        };
    }

    // FUNGSI 5: MENAMPILKAN GRAFIK PENDUDUK
    function renderPopulationChart() {
        if (typeof Chart === 'undefined') return;

        const processedData = processPopulationData();
        if (!processedData) return;

        const ctx = document.getElementById('chart-kependudukan').getContext('2d');
        
        if (window.populationChart) {
            window.populationChart.destroy();
        }
        
        window.populationChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: processedData.labels, 
                datasets: [{
                    label: 'Total Penduduk',
                    data: processedData.data,
                    backgroundColor: [
                        'rgba(3, 102, 214, 0.7)',
                        'rgba(40, 167, 69, 0.7)',
                        'rgba(255, 193, 7, 0.7)'
                    ],
                    borderColor: [
                        'rgba(3, 102, 214, 1)',
                        'rgba(40, 167, 69, 1)',
                        'rgba(255, 193, 7, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, 
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }

    // FUNGSI 6: MEMPROSES DATA CSV ANGGARAN UNTUK CHART (GRAFIK DONAT)
    function processAnggaranData() {
        const csvElement = document.getElementById('csv-anggaran');
        if (!csvElement) return null;

        const csvData = csvElement.textContent.trim();
        const rows = csvData.split('\n');
        
        const totals = {};
        const header = rows[0].split(',').map(h => h.trim());
        const anggaranIndex = header.indexOf('anggaran_rp'); 
        const bidangIndex = header.indexOf('bidang'); 

        if (anggaranIndex === -1 || bidangIndex === -1) return null;

        for (let i = 1; i < rows.length; i++) {
            const columns = rows[i].split(',');
            const bidang = columns[bidangIndex].trim();
            // Hapus karakter non-digit dan parse sebagai integer
            const anggaran = parseInt(columns[anggaranIndex].trim().replace(/\D/g,''));

            if (totals[bidang]) {
                totals[bidang] += anggaran;
            } else {
                totals[bidang] = anggaran;
            }
        }
        
        return {
            labels: Object.keys(totals),
            data: Object.values(totals)
        };
    }

    // FUNGSI 7: MENAMPILKAN GRAFIK DONAT ANGGARAN
    function renderAnggaranChart() {
        if (typeof Chart === 'undefined') return;

        const processedData = processAnggaranData();
        if (!processedData) return;

        const ctx = document.getElementById('chart-anggaran').getContext('2d');
        
        if (window.anggaranChart) {
            window.anggaranChart.destroy();
        }
        
        window.anggaranChart = new Chart(ctx, {
            type: 'doughnut', 
            data: {
                labels: processedData.labels, 
                datasets: [{
                    label: 'Total Anggaran (Rp)',
                    data: processedData.data,
                    backgroundColor: [
                        '#0366d6', 
                        '#28a745', 
                        '#ffc107',
                        '#dc3545'  
                    ],
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                let value = context.parsed;
                                // Format angka sebagai mata uang Rupiah
                                label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(value);
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    // Global variable untuk menyimpan instance peta
    let mapFasilitas = null;

    // FUNGSI 8: MEMPROSES DATA CSV FASILITAS UNTUK PETA
    function processFasilitasData() {
        const csvElement = document.getElementById('csv-fasilitas');
        if (!csvElement) return [];

        const csvData = csvElement.textContent.trim();
        const rows = csvData.split('\n');
        if (rows.length < 2) return [];

        const header = rows[0].split(',').map(h => h.trim());
        const latIndex = header.indexOf('latitude');
        const lonIndex = header.indexOf('longitude');
        const namaIndex = header.indexOf('nama_fasilitas');
        const kategoriIndex = header.indexOf('kategori');
        const alamatIndex = header.indexOf('alamat');

        const markers = [];
        for (let i = 1; i < rows.length; i++) {
            const columns = rows[i].split(',');
            const lat = parseFloat(columns[latIndex]?.trim());
            const lon = parseFloat(columns[lonIndex]?.trim());

            if (!isNaN(lat) && !isNaN(lon)) {
                markers.push({
                    lat: lat,
                    lon: lon,
                    nama: columns[namaIndex]?.trim(),
                    kategori: columns[kategoriIndex]?.trim(),
                    alamat: columns[alamatIndex]?.trim()
                });
            }
        }
        return markers;
    }

    // FUNGSI 9: MENAMPILKAN PETA LEAFLET
    function renderFasilitasMap() {
        if (typeof L === 'undefined') return;

        const markerData = processFasilitasData();
        
        if (mapFasilitas) {
            mapFasilitas.remove();
            mapFasilitas = null;
        }

        const defaultLat = -7.1245; 
        const defaultLon = 110.1245; 
        const centerLat = markerData.length > 0 ? markerData[0].lat : defaultLat;
        const centerLon = markerData.length > 0 ? markerData[0].lon : defaultLon;

        mapFasilitas = L.map('map-fasilitas').setView([centerLat, centerLon], 14); 

        // Tile Layer
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(mapFasilitas);

        // Tambahkan Marker
        markerData.forEach(item => {
            const popupContent = `
                <strong>${item.nama}</strong><br>
                Kategori: ${item.kategori}<br>
                Alamat: ${item.alamat}<br>
                Koordinat: ${item.lat}, ${item.lon}
            `;
            L.marker([item.lat, item.lon])
                .addTo(mapFasilitas)
                .bindPopup(popupContent);
        });
    }

    // FUNGSI 10: TOGGLE (Menampilkan/Menyembunyikan Pratinjau, Grafik, dan Peta)
    function togglePreview(button, containerId, csvId, previewId, maxRows) {
        const container = document.getElementById(containerId);
        
        if (container.style.display === 'block') {
            container.style.display = 'none';
            button.textContent = 'Lihat Pratinjau';
            
            // Hapus instance peta saat disembunyikan
            if (csvId === 'csv-fasilitas' && mapFasilitas) {
                mapFasilitas.remove();
                mapFasilitas = null;
            }

        } else {
            const previewElement = document.getElementById(previewId);
            
            // 1. Cek dan Buat Tabel
            if (previewElement.innerHTML.trim() === '') {
                generatePreview(csvId, previewId, maxRows);
            }
            
            // 2. RENDER GRAFIK KEPENDUDUKAN
            if (csvId === 'csv-kependudukan') {
                renderPopulationChart();
            }
            
            // 3. RENDER GRAFIK ANGGARAN
            if (csvId === 'csv-anggaran') {
                renderAnggaranChart();
            }

            // 4. RENDER PETA
            if (csvId === 'csv-fasilitas') {
                container.style.display = 'block'; 
                button.textContent = 'Sembunyikan Pratinjau';
                renderFasilitasMap();
                return; 
            }
            
            container.style.display = 'block';
            button.textContent = 'Sembunyikan Pratinjau';
        }
    }

    // FUNGSI 11: EKSEKUSI SAAT HALAMAN DIMUAT
    window.onload = function() {
        if (document.getElementById('searchInput') && document.getElementById('searchInput').value) {
            filterData(); 
        }
    };
    </script>

</body>
</html>
